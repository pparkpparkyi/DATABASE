-- =============================================================================
-- SUNINE (순이네 샤인머스캣 농장) 데이터베이스 영상 시연 실행 스크립트
-- =============================================================================
-- 이 스크립트는 SUNINE/video_demonstration_script.md 파일의 내용을 기반으로
-- MySQL Workbench 등에서 단계별로 실행할 수 있도록 구성되었습니다.
-- 각 SQL 명령어 실행 전후의 멘트는 주석으로 처리되어 있습니다.
--
-- 사용 전 주의사항:
-- 1. `master_setup.sql`을 먼저 실행하여 데이터베이스 스키마와 초기 데이터를
--    완전히 구성했는지 확인하십시오.
-- 2. 이 스크립트는 `dummy_data.sql`의 데이터 상태를 기준으로 일부 예상값을
--    언급하고 있습니다. 스크립트를 부분적으로 또는 반복적으로 실행하는 경우
--    데이터 상태가 달라져 예상과 다른 결과가 나올 수 있습니다.
-- =============================================================================

-- 데이터베이스 선택 (필요시 주석 해제 후 실행)
-- USE sunine_db;

-- --------------------------------------------------------------------------------
-- 섹션 0: 데이터베이스 연결 및 확인 (영상 시작 부분)
-- --------------------------------------------------------------------------------
-- 화면: Workbench 실행 → `sunine_db` 데이터베이스 연결 (이 부분은 사용자가 직접 수행)
-- 멘트: 안녕하세요, 순이네 샤인머스캣 농장 데이터베이스 시연을 시작하겠습니다. 먼저 sunine_db 데이터베이스에 연결했습니다. 이제 데이터베이스와 테이블이 정상적으로 생성되었는지 확인해보겠습니다.

SHOW DATABASES LIKE 'sunine_db%'; -- sunine_db가 있는지 확인
USE sunine_db;                   -- sunine_db 사용
SHOW TABLES;                     -- sunine_db 안의 테이블 목록 표시

-- 멘트: 네, 보시는 것처럼 sunine_db 데이터베이스가 존재하며, 관련된 테이블들도 모두 잘 생성된 것을 확인할 수 있습니다.
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 1: 주요 테이블 초기 데이터 확인
-- --------------------------------------------------------------------------------
-- 멘트: 이제 `master_setup.sql` 스크립트를 통해 생성된 주요 테이블들의 초기 데이터를 간략히 살펴보겠습니다.

-- 고객 테이블 확인
SELECT * FROM Customer LIMIT 3;

-- 상품 테이블 확인 (재고 포함)
SELECT itemId, itemName, price, itemStock FROM Item LIMIT 3;

-- 주문 테이블 확인
SELECT * FROM `Order` LIMIT 3;

-- 멘트: 이렇게 고객, 상품, 주문 등의 주요 테이블에 초기 데이터가 들어가 있으며, Item 테이블에는 새로 추가된 `itemStock` 열에서 각 상품의 초기 재고량도 확인할 수 있습니다.
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 2: 간단한 재고 증가 시연 (수확)
-- --------------------------------------------------------------------------------
-- 멘트: 농장에서 수확이 발생하면, `HarvestLog`에 기록되고 해당 상품의 재고(`itemStock`)가 `trg_update_stock_on_harvest` 트리거에 의해 자동으로 증가합니다. 상품 ID 1의 재고 변화를 보겠습니다.

-- 상품 ID 1의 현재 재고 확인 (dummy_data 실행 후 예상 재고: 147)
SELECT itemName, itemStock FROM Item WHERE itemId = 1;
-- (멘트: 상품 ID 1의 현재 재고는 [현재 값]입니다.)

-- 상품 ID 1에 대한 수확 20개 기록 (farmId = 1)
INSERT INTO HarvestLog (itemId, farmId, quantityHarvested) VALUES (1, 1, 20);
-- (멘트: 수확 20개를 HarvestLog에 기록했습니다.)

-- 증가된 재고 확인
SELECT itemName, itemStock FROM Item WHERE itemId = 1;
-- 멘트: 보시는 것처럼, 수확 기록 후 상품 ID 1의 재고가 20만큼 증가했습니다. (예상: 147 + 20 = 167)
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 3: 간단한 주문 및 재고 감소 시연
-- --------------------------------------------------------------------------------
-- 멘트: 고객이 상품을 주문하면, `trg_decrease_stock_on_order` 트리거에 의해 해당 상품의 재고(`itemStock`)가 주문 수량만큼 자동으로 감소합니다. 상품 ID 5의 재고 변화를 보겠습니다.

-- 상품 ID 5의 현재 재고 확인 (dummy_data 실행 후 예상 재고: 198)
SELECT itemName, itemStock FROM Item WHERE itemId = 5;
-- (멘트: 상품 ID 5의 현재 재고는 [현재 값]입니다.)

-- 고객 ID 1이 상품 ID 5를 3개 주문
INSERT INTO `Order` (customerId, itemId, quantity, deliveryAddress) VALUES (1, 5, 3, 'Test Address for Stock Demo');
-- (멘트: 고객 ID 1이 상품 ID 5를 3개 주문했습니다.)

-- 감소된 재고 확인
SELECT itemName, itemStock FROM Item WHERE itemId = 5;
-- 멘트: 주문 후 상품 ID 5의 재고가 3만큼 감소한 것을 확인할 수 있습니다. (예상: 198 - 3 = 195)
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 4: 고객 리뷰 작성, 평균 평점 및 선호 등급 업데이트 (트리거 시연)
-- --------------------------------------------------------------------------------
-- 멘트: 다음은 고객이 상품에 대한 리뷰를 작성했을 때 관련된 자동 업데이트 기능입니다. 상품 ID 2번의 초기 평균 평점을 확인하고, 고객 ID 3번이 해당 상품에 대해 새 리뷰를 작성한 후 평균 평점과 고객 선호 등급이 어떻게 변경되는지 보겠습니다.

-- 상품 ID 2번의 초기 averageRating 확인
SELECT itemId, itemName, averageRating, itemRank FROM Item WHERE itemId = 2;
-- (멘트: 상품 ID 2번의 현재 평균 평점은 [X.X]이고, 등급은 [Rank]입니다.)

-- 고객 ID 3번이 상품 ID 2번에 대해 별점 5점과 함께 리뷰 작성
INSERT INTO Review (customerId, itemId, rating, comment)
VALUES (3, 2, 5, '아주 만족합니다! 최고의 포도예요!');
-- (멘트: 새로운 리뷰를 삽입했습니다.)

-- 상품 ID 2번의 업데이트된 averageRating 확인
SELECT itemId, itemName, averageRating FROM Item WHERE itemId = 2;
-- (멘트: 리뷰가 추가된 후, 상품 ID 2번의 평균 평점이 업데이트된 것을 확인할 수 있습니다. 이는 `trg_update_avg_rating` 트리거가 작동했음을 보여줍니다.)

-- 고객 ID 3의 선호 등급에 상품 ID 2의 등급이 추가되었는지 확인 (trg_update_preferrank_on_review)
SELECT * FROM PreferRank WHERE customerId = 3 AND itemRank = (SELECT itemRank FROM Item WHERE itemId = 2);
-- 멘트: 또한, 높은 평점을 받은 상품의 등급이 해당 고객의 선호 등급으로 자동 추가된 것을 `PreferRank` 테이블에서 확인할 수 있습니다 (이미 있다면 무시됩니다). 이는 `trg_update_preferrank_on_review` 트리거의 결과입니다.
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 5: 고객 불량/결함 보고 및 주문 상태 변경 (트리거 시연)
-- --------------------------------------------------------------------------------
-- 멘트: 고객이 주문한 상품에 대해 불량/결함을 보고하면, `trg_update_order_status_on_defect` 트리거에 의해 해당 주문의 상태가 'REFUND_REQUESTED'(환불 요청)으로 자동 변경됩니다. 주문 ID 2번의 상태 변화를 보겠습니다.

-- (dummy_data.sql의 주문 ID 2번: 고객 ID 2, 상품 ID 3)
-- 주문 ID 2번의 초기 orderStatus 확인
SELECT orderId, customerId, itemId, orderStatus FROM `Order` WHERE orderId = 2;
-- (멘트: 주문 ID 2번의 현재 주문 상태는 [기존상태] 입니다.)

-- 주문 ID 2번에 대한 불량 보고 접수 (고객 ID 2, 상품 ID 3)
INSERT INTO DefectReport (orderId, itemId, customerId, reason, imageUrl)
VALUES (2, 3, 2, '일부 포도알이 상했고, 배송 중 박스가 약간 훼손되었습니다.', 'http://example.com/new_defect.jpg');
-- (멘트: 새로운 불량 보고를 삽입했습니다.)

-- 주문 ID 2번의 업데이트된 orderStatus 확인
SELECT orderId, customerId, itemId, orderStatus FROM `Order` WHERE orderId = 2;
-- 멘트: 불량 보고가 추가된 후, 주문 ID 2번의 주문 상태가 'REFUND_REQUESTED'로 업데이트된 것을 확인할 수 있습니다.
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 6: 환불 처리 (프로시저 시연)
-- --------------------------------------------------------------------------------
-- 멘트: 이제, 관리자가 접수된 불량 보고에 대해 환불을 처리하는 `proc_process_refund` 프로시저를 시연하겠습니다. 주문 ID 4번과 관련된 불량 보고 ID 1번을 예시로 사용합니다.

-- 주문 ID 4번의 초기 orderStatus 및 불량 보고 ID 1번의 초기 상태 확인
SELECT orderId, orderStatus FROM `Order` WHERE orderId = 4;
SELECT reportId, processed, refundAmount FROM DefectReport WHERE reportId = 1 AND orderId = 4;
-- (멘트: 주문 ID 4번은 'REFUND_REQUESTED' 상태이고, 불량 보고 ID 1번은 아직 처리되지 않았습니다.)

-- 환불 처리 프로시저 호출
CALL proc_process_refund(4, 1);
-- (멘트: 환불 처리 프로시저를 호출했습니다.)

-- 주문 ID 4번의 업데이트된 orderStatus 및 불량 보고 ID 1번의 업데이트된 상태 확인
SELECT orderId, orderStatus FROM `Order` WHERE orderId = 4;
SELECT reportId, processed, refundAmount FROM DefectReport WHERE reportId = 1 AND orderId = 4;
-- 멘트: 프로시저 실행 후, 주문 상태가 'REFUNDED'로 변경되고, 불량 보고의 처리 상태와 환불액이 업데이트된 것을 확인할 수 있습니다.

-- 주문 4번의 상품 ID와 수량, 해당 상품의 가격 확인 (환불액 검증용)
-- SELECT O.itemId, I.itemName, O.quantity, I.price, (O.quantity * I.price) AS expectedRefundAmount
-- FROM `Order` O JOIN Item I ON O.itemId = I.itemId
-- WHERE O.orderId = 4;
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 7: 상품별 불량률 계산 (함수 시연)
-- --------------------------------------------------------------------------------
-- 멘트: 특정 상품의 불량률을 계산하는 `fn_get_defectRate` 함수를 시연하겠습니다. 상품 ID 1번에 대한 불량률입니다.

SELECT fn_get_defectRate(1) AS defectRate_Item1;
-- 멘트: 함수 실행 결과, 상품 ID 1번의 불량률은 [계산된 값]입니다.
-- --------------------------------------------------------------------------------

-- --------------------------------------------------------------------------------
-- 섹션 8: 품질 검사 등록 (프로시저 시연)
-- --------------------------------------------------------------------------------
-- 멘트: 마지막으로, 농장 작업자가 품질 검사 결과를 등록하는 `proc_register_inspection` 프로시저입니다. 상품 ID 5번, 농장 ID 1번에 대해 '홍길동' 검사자가 'FAIL' 결과를 등록합니다.

CALL proc_register_inspection(5, 1, 'FAIL', '홍길동');
-- (멘트: 품질 검사 등록 프로시저를 호출했습니다.)

SELECT * FROM QualityInspection WHERE itemId = 5 AND farmId = 1 AND inspectorName = '홍길동' ORDER BY inspectionDate DESC LIMIT 1;
-- 멘트: 품질 검사 테이블에서 해당 내용이 등록된 것을 확인할 수 있습니다. 이상으로 주요 기능 시연을 마치겠습니다. 감사합니다.
-- --------------------------------------------------------------------------------

-- =============================================================================
-- 영상 시연 실행 스크립트 종료
-- =============================================================================
